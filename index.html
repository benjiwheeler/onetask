<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Task</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 60px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 40px;
            font-weight: 700;
        }

        .task-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes flyLeftSpin {
            0% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateX(-150%) rotate(-360deg);
            }
        }

        @keyframes flyUpRightComplete {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            25% {
                opacity: 1;
                transform: translate(30px, 30px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(100%, -100%) scale(1.5);
            }
        }

        .task-card.fly-left {
            animation: flyLeftSpin 0.6s ease-in forwards;
        }

        .task-card.fly-complete {
            animation: flyUpRightComplete 0.8s ease-out forwards;
        }

        .task-name {
            font-size: 2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .task-details {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .detail-item {
            flex: 1;
            min-width: 150px;
        }

        .detail-label {
            font-size: 0.9em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 1.3em;
            color: #4a5568;
            font-weight: 600;
        }

        .priority-high {
            color: #e53e3e;
        }

        .priority-medium {
            color: #dd6b20;
        }

        .priority-low {
            color: #38a169;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-different {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            box-shadow: 0 4px 15px rgba(253, 160, 133, 0.4);
        }

        .btn-different:hover {
            box-shadow: 0 6px 20px rgba(253, 160, 133, 0.6);
        }

        .btn-done {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-done:hover {
            box-shadow: 0 6px 20px rgba(86, 171, 47, 0.6);
        }

        .loading {
            color: #667eea;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .error {
            color: #e53e3e;
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>One Task</h1>
        <div id="taskDisplay">
            <div class="loading">One Task Only</div>
        </div>
        <div id="buttonContainer">
            <button id="pickTaskBtn">Show just one task</button>
        </div>
    </div>

    <script>
        const SHEET_ID = '115SgANqyv_GaLVTpIlEzRrpuOBTWraMK9_-WEAcsGZE';
        const SHEET_NAME = 'Sheet1'; // Adjust if your sheet has a different name

        let tasks = [];
        let currentTask = null;

        async function fetchTasks() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
            const display = document.getElementById('taskDisplay');

            try {
                display.innerHTML += '<div class="loading">üì° Fetching from Google Sheets...</div>';
                console.log('Fetching URL:', url);

                const response = await fetch(url);
                display.innerHTML += `<div class="loading">‚úì Response received! Status: ${response.status}</div>`;
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const text = await response.text();
                display.innerHTML += `<div class="loading">‚úì Got ${text.length} characters of data</div>`;
                console.log('Raw response (first 500 chars):', text.substring(0, 500));

                // Parse Google Sheets JSON response (it's wrapped in a function call)
                display.innerHTML += '<div class="loading">üîç Parsing JSON...</div>';
                const jsonString = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);

                display.innerHTML += `<div class="loading">‚úì JSON parsed! Found ${data.table.rows.length} rows</div>`;
                console.log('Parsed data:', data);

                tasks = [];
                const rows = data.table.rows;

                // Skip header row (index 0) and parse data rows
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.c && row.c[0]) { // Check if row has data
                        const task = {
                            name: row.c[0]?.v || 'Unnamed Task',
                            dueDate: row.c[1]?.f || row.c[1]?.v || 'No date',
                            priority: (row.c[2]?.v || 'Medium').toString()
                        };
                        tasks.push(task);
                        display.innerHTML += `<div class="loading">‚Ä¢ Found task: ${task.name} (Priority: ${task.priority})</div>`;
                    }
                }

                display.innerHTML += `<div class="loading">‚úì Loaded ${tasks.length} tasks total!</div>`;
                console.log('All tasks:', tasks);

                return tasks.length > 0;
            } catch (error) {
                console.error('Error fetching tasks:', error);
                display.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
                display.innerHTML += `<div class="error">Stack: ${error.stack}</div>`;
                return false;
            }
        }

        function calculateWeight(task) {
            // Priority weights: High = 3, Medium = 2, Low = 1
            let priorityWeight = 1;
            const priority = (task.priority || 'medium').toString().toLowerCase();
            if (priority.includes('high')) priorityWeight = 3;
            else if (priority.includes('medium')) priorityWeight = 2;

            // Date weight: earlier dates get higher weights
            let dateWeight = 1;
            try {
                const dueDate = new Date(task.dueDate);
                if (!isNaN(dueDate.getTime())) {
                    const today = new Date();
                    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                    // Earlier dates get higher weights
                    if (daysUntilDue < 0) dateWeight = 4; // Overdue
                    else if (daysUntilDue <= 7) dateWeight = 3; // Due within a week
                    else if (daysUntilDue <= 30) dateWeight = 2; // Due within a month
                    else dateWeight = 1; // Due later
                }
            } catch (e) {
                // If date parsing fails, use default weight
            }

            return priorityWeight * dateWeight;
        }

        function pickRandomTask() {
            if (tasks.length === 0) return null;

            // If there's only one task, return it
            if (tasks.length === 1) return tasks[0];

            // Filter out the current task to avoid showing it again
            let availableTasks = tasks;
            if (currentTask) {
                availableTasks = tasks.filter(task => task.name !== currentTask.name);
                // If all tasks were filtered out (shouldn't happen), use all tasks
                if (availableTasks.length === 0) {
                    availableTasks = tasks;
                }
            }

            // Calculate total weight
            const weights = availableTasks.map(calculateWeight);
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);

            // Pick random number
            let random = Math.random() * totalWeight;

            // Find the task based on weighted random selection
            for (let i = 0; i < availableTasks.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return availableTasks[i];
                }
            }

            return availableTasks[availableTasks.length - 1]; // Fallback
        }

        function getPriorityClass(priority) {
            const p = (priority || 'medium').toString().toLowerCase();
            if (p.includes('high')) return 'priority-high';
            if (p.includes('medium')) return 'priority-medium';
            if (p.includes('low')) return 'priority-low';
            return '';
        }

        function displayTask(task) {
            currentTask = task;
            const display = document.getElementById('taskDisplay');
            const buttonContainer = document.getElementById('buttonContainer');

            display.innerHTML = `
                <div class="task-card">
                    <div class="task-name">${task.name}</div>
                    <div class="task-details">
                        <div class="detail-item">
                            <div class="detail-label">Due Date</div>
                            <div class="detail-value">${task.dueDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value ${getPriorityClass(task.priority)}">${task.priority}</div>
                        </div>
                    </div>
                </div>
            `;

            // Show the two action buttons
            buttonContainer.innerHTML = `
                <div class="button-group">
                    <button id="differentTaskBtn" class="btn-different">üîÑ Show a different task</button>
                    <button id="doneBtn" class="btn-done">‚úì Done</button>
                </div>
            `;

            // Add event listeners
            document.getElementById('differentTaskBtn').addEventListener('click', () => handlePickTask('different'));
            document.getElementById('doneBtn').addEventListener('click', () => handlePickTask('done'));
        }

        async function handlePickTask(actionType = null) {
            const display = document.getElementById('taskDisplay');
            const buttonContainer = document.getElementById('buttonContainer');

            // Disable all buttons during load
            const allButtons = buttonContainer.querySelectorAll('button');
            allButtons.forEach(btn => btn.disabled = true);

            // If there's a current task and an action type, animate it out
            if (actionType && currentTask) {
                const taskCard = display.querySelector('.task-card');
                if (taskCard) {
                    // Apply the appropriate animation class
                    if (actionType === 'different') {
                        taskCard.classList.add('fly-left');
                    } else if (actionType === 'done') {
                        taskCard.classList.add('fly-complete');
                    }

                    // Wait for animation to complete
                    await new Promise(resolve => setTimeout(resolve, actionType === 'done' ? 800 : 600));
                }
            }

            display.innerHTML = '<div class="spinner"></div><div class="loading">Loading tasks...</div>';

            // Only fetch tasks if we haven't already
            if (tasks.length === 0) {
                const success = await fetchTasks();

                if (!success || tasks.length === 0) {
                    display.innerHTML = '<div class="error">Could not load tasks. Please make sure the spreadsheet is publicly accessible.</div>';
                    allButtons.forEach(btn => btn.disabled = false);
                    return;
                }
            }

            // Clear debug messages and show the selected task
            const selectedTask = pickRandomTask();
            if (selectedTask) {
                display.innerHTML = ''; // Clear all debug messages
                displayTask(selectedTask);
            }
        }

        // Event listener for initial button
        document.getElementById('pickTaskBtn').addEventListener('click', handlePickTask);
    </script>
</body>
</html>
